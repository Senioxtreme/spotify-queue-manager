<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#121212" />
  <title>Spotify Song Queue</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;line-height:1.5;-webkit-font-smoothing:antialiased;
      min-height:100svh;display:flex;flex-direction:column;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(29,185,84,.18), rgba(29,185,84,0) 60%),
        radial-gradient(800px 400px at 110% 0%, rgba(30,215,96,.12), rgba(30,215,96,0) 60%),
        linear-gradient(180deg,#0e0e0e 0%, #121212 35%, #0f1f15 100%);
      color:#fafafa;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial
    }
    img{display:block;max-width:100%}
    input,button{font:inherit}
    :root{--panel:#181818;--panel-2:#202020;--muted:#b3b3b3;--brand:#1DB954;--brand-2:#1ED760;--radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35)}

    .container{width:100%;max-width:1200px;margin:0 auto;padding:10px}
    header.appbar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(to bottom, rgba(18,18,18,.95), rgba(18,18,18,.7));border-bottom:1px solid rgba(255,255,255,.06)}
    .appbar-inner{display:flex;gap:10px;align-items:center;padding:8px 10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:8px}
    .brand img{width:32px;height:32px;cursor:pointer}
    
    /* Stili per il widget Now Playing */
    #now-playing-widget{display:none;align-items:center;gap:10px;margin-left:auto;background:rgba(255,255,255,.05);padding:4px 8px 4px 4px;border-radius:8px;overflow:hidden;max-width:300px}
    #now-playing-widget.visible{display:flex}
    #np-cover{width:32px;height:32px;border-radius:4px;object-fit:cover}
    #np-info{display:flex;flex-direction:column;min-width:0}
    #np-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #np-artists{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .searchbar{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:999px;padding:6px 10px;flex:1;min-width:200px}
    .searchbar input{flex:1;outline:none;border:none;background:transparent;color:#fafafa}
    .searchbar input:disabled{cursor:not-allowed;color:var(--muted)}

    .btn{border:none;border-radius:12px;padding:8px 12px;background:linear-gradient(45deg,var(--brand),var(--brand-2));color:white;font-weight:700;cursor:pointer;transition:transform .15s ease;white-space:nowrap}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{cursor:not-allowed;background:#262626;color:var(--muted)}
    .btn.small{padding:6px 8px;border-radius:8px;font-size:12px;background:#262626;border:1px solid rgba(255,255,255,.08)}
    .btn.ghost{background:#1b1b1b;border:1px solid rgba(255,255,255,.08);color:#eaeaea}

    main{flex:1}
    .content{display:grid;grid-template-columns:1fr 300px;gap:12px}
    @media (max-width:900px){.content{grid-template-columns:1fr}}

    #results{list-style:none;padding:0;margin:10px 0}
    #results.grid{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(110px,1fr))}
    @media (max-width:1100px){#results.grid{grid-template-columns:repeat(4,minmax(110px,1fr))}}
    @media (max-width:960px){#results.grid{grid-template-columns:repeat(3,minmax(110px,1fr))}}
    @media (max-width:720px){#results.grid{grid-template-columns:repeat(2,minmax(120px,1fr))}}
    @media (max-width:400px){#results.grid{grid-template-columns:repeat(2,minmax(100px,1fr))}}
    #results.list{display:flex;flex-direction:column;gap:8px}

    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease;position:relative}
    .card:hover{transform:translateY(-2px)}
    .cover{position:relative;aspect-ratio:1/1;overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover;transform-origin:center}
    .info{padding:8px 10px}
    .title{font-size:14px;font-weight:800;white-space:normal;overflow-wrap:break-word}
    .meta{font-size:12px;color:var(--muted);white-space:normal;overflow-wrap:break-word}
    .row{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px 10px;flex-wrap:wrap}

    #results.list .card{flex-direction:row;align-items:center;padding:4px 6px}
    #results.list .cover{width:60px;height:60px;min-width:60px;border-radius:8px;margin:4px}
    #results.list .info{padding:0 8px;min-width:0}
    #results.list .row{margin-left:auto;padding:0}

    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:10px;position:sticky;top:72px;max-height:calc(100vh - 100px);overflow:auto}
    .panel .panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .panel h2{margin:0;font-size:15px}
    .q-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .q-item{display:flex;gap:8px;align-items:center;background:#161616;border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:6px}
    .q-item img{width:40px;height:40px;border-radius:6px;object-fit:cover}
    .qi-title{font-size:13px;font-weight:700;white-space:normal;overflow-wrap:break-word}
    .qi-sub{font-size:11px;color:var(--muted);white-space:normal;overflow-wrap:break-word}

    .state{display:none;align-items:center;justify-content:center;border:1px dashed rgba(255,255,255,.12);border-radius:var(--radius);padding:12px;text-align:center;color:var(--muted)}
    .state.active{display:flex}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(120%);background:#1b1b1b;color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:10px 14px;z-index:999;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;opacity:0;transition:transform .25s ease, opacity .25s ease}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{background:#2a1717;border-color:rgba(255,80,80,.35)}
    .toast .icon{font-weight:900}

    @keyframes ring{0%{box-shadow:0 0 0 0 rgba(29,185,84,.65)}100%{box-shadow:0 0 0 14px rgba(29,185,84,0)}}
    .card.added{animation:ring .75s ease-out}
    .added-badge{position:absolute;bottom:8px;right:8px;background:linear-gradient(45deg,var(--brand),var(--brand-2));color:#fff;padding:6px 8px;border-radius:999px;font-size:12px;font-weight:800;pointer-events:none;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    @keyframes cover-bump{0%{transform:scale(1)}60%{transform:scale(1.05)}100%{transform:scale(1)}}
    .cover.bump img{animation:cover-bump .45s ease-out}

    .confetti{position:fixed;pointer-events:none;inset:0;z-index:998}

    /* Modal embed preview */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
    .modal.show{display:flex}
    .modal-card{width:min(520px,90vw);background:#181818;border:1px solid rgba(255,255,255,.08);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .modal-title{font-weight:800}
    .modal-body{padding:0}
    .modal-close{background:#262626;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}

    footer{margin-top:auto;padding:12px;text-align:center;color:#b3b3b3;font-size:12px}
    footer a{color:var(--brand);text-decoration:none}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-inner container">
      <a class="brand" id="home-link" href="#" aria-label="Home">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/2048px-Spotify_logo_without_text.svg.png" alt="Spotify" />
      </a>
      <div class="searchbar" role="search">
        <input id="song-query" type="text" placeholder="Search songs, artists, albums…" autocomplete="off" aria-label="Search" disabled />
      </div>
      <button id="search-btn" class="btn" disabled>Search</button>

      <!-- Widget Now Playing -->
      <div id="now-playing-widget">
        <img id="np-cover" src="" alt="Album cover">
        <div id="np-info">
          <div id="np-title"></div>
          <div id="np-artists"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="content">
      <section>
        <div id="state-empty" class="state active">Start by searching your favorite track.</div>
        <div id="state-loading" class="state">Searching… hold tight.</div>
        <div id="state-error" class="state">Something went wrong. Try again.</div>
        <ul id="results" class="grid" aria-label="Search results"></ul>
      </section>
      <aside class="panel">
        <div class="panel-head">
          <h2>History <span id="hist-count" style="color:var(--muted);font-weight:500"></span></h2>
          <button id="clear-history" class="btn small ghost" title="Clear history">Clear</button>
        </div>
        <ul id="user-queue" class="q-list" aria-live="polite" aria-label="Last 5 added"></ul>
      </aside>
    </div>
  </main>

  <!-- Modal Tutorial -->
  <div id="tutorial-modal" class="modal" role="dialog" aria-label="Benvenuto!">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="event-title">Benvenuto!</div>
      </div>
      <div class="modal-body" style="padding: 15px; color: #b3b3b3; line-height: 1.6;">
        <p>Questa è la console per richiedere le tue canzoni preferite!</p>
        <p><strong>Come funziona:</strong></p>
        <ol style="padding-left: 20px;">
          <li>Usa la barra di ricerca in alto per trovare un brano.</li>
          <li>Clicca su "Add to queue" per aggiungerlo alla playlist.</li>
          <li>Il tuo brano verrà messo in coda e suonato presto!</li>
        </ol>
        <p><strong>Limiti:</strong> Puoi aggiungere un massimo di 3 brani ogni 10 minuti per dare a tutti la possibilità di partecipare.</p>
        <div style="text-align: center; margin-top: 20px;">
          <button id="tutorial-close" class="btn">Ho capito, iniziamo!</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Developed by <a href="https://senioxtreme.it" target="_blank" rel="noreferrer noopener">Senioxtreme</a></footer>

  <div id="toast" class="toast" role="status" aria-live="polite"><span class="icon">✓</span><span id="toast-text"></span></div>
  <canvas id="confetti" class="confetti"></canvas>

  <!-- Modal embed -->
  <div id="embed-modal" class="modal" aria-hidden="true" role="dialog" aria-label="Track preview">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">Track preview</div>
        <button id="embed-close" class="modal-close">Close</button>
      </div>
      <div class="modal-body">
        <iframe id="embed-frame" style="border:none;width:100%;height:152px"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <script>
    (function hardOverrideDialogs(){
      function htmlToast(msg){
        const t=document.getElementById('toast');
        const txt=document.getElementById('toast-text');
        if(!t||!txt) return;
        const m=(msg==null?'':String(msg));
        const isErr=/error|slow|limit|riprov|problem|no active device|valid search term|device/i.test(m);
        const icon=t.querySelector('.icon');
        if(icon) icon.textContent = isErr ? '⚠' : '✓';
        t.classList.toggle('error', isErr);
        txt.textContent=m;
        t.classList.add('show');
        clearTimeout(htmlToast._t);
        htmlToast._t=setTimeout(()=>t.classList.remove('show'),3500);
      }
      function setFn(name, fn, ret){
        try{ Object.defineProperty(window,name,{configurable:true,enumerable:true,writable:true,value:(...args)=>{ fn(args[0]); return ret; }}); }
        catch{ window[name]=(...args)=>{ fn(args[0]); return ret; }; }
      }
      setFn('alert', htmlToast, undefined);
      setFn('confirm', htmlToast, true);
      setFn('prompt', htmlToast, '');
      setInterval(()=>{ if(window.alert!==htmlToast) setFn('alert', htmlToast); }, 1000);
      window.showToast = htmlToast;
    })();
  </script>

  <script>
    const ext=document.createElement('script');
    ext.src='script.js?v='+Date.now();
    document.head.appendChild(ext);
  </script>

  <script>
    (function(){
      const q=document.getElementById('song-query');
      const searchBtn=document.getElementById('search-btn');
      const results=document.getElementById('results');
      const empty=document.getElementById('state-empty');
      const loading=document.getElementById('state-loading');
      const error=document.getElementById('state-error');
      const userQueue=document.getElementById('user-queue');
      const histCount=document.getElementById('hist-count');
      const clearBtn=document.getElementById('clear-history');
      const confetti=document.getElementById('confetti');
      const ctx=confetti.getContext('2d');

      const audio = new Audio();
      let currentPreviewBtn = null;

      const modal = document.getElementById('embed-modal');
      const embedFrame = document.getElementById('embed-frame');
      const embedClose = document.getElementById('embed-close');

      document.getElementById('home-link').addEventListener('click',(e)=>{
        e.preventDefault();
        stopPreview();
        closeEmbed();
        q.value=''; results.innerHTML=''; setState('empty'); window.scrollTo({top:0,behavior:'smooth'});
      });

      function setState(name){
        [empty,loading,error].forEach(el=>el.classList.remove('active'));
        if(name==='empty') empty.classList.add('active');
        if(name==='loading') loading.classList.add('active');
        if(name==='error') error.classList.add('active');
      }
      const showPopup=(msg)=> (window.showToast||(()=>{}))(msg==null?'':String(msg));

      function fireConfetti(){
        const W=confetti.width=window.innerWidth, H=confetti.height=window.innerHeight;
        const pieces=Array.from({length:18},()=>({x:Math.random()*W,y:-10,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,s:3+Math.random()*4}));
        let t=0; cancelAnimationFrame(fireConfetti._r);
        (function loop(){
          t++; ctx.clearRect(0,0,W,H);
          pieces.forEach(p=>{p.x+=p.vx; p.y+=p.vy; ctx.fillStyle=`hsl(${(t*6+p.x)%360} 80% 60%)`; ctx.fillRect(p.x,p.y,p.s,p.s*1.6);});
          if(t<40) fireConfetti._r=requestAnimationFrame(loop); else ctx.clearRect(0,0,W,H);
        })();
      }

      function decideLayout(){
        const imgs=[...results.querySelectorAll('.cover img, .result-item img')];
        if(!imgs.length)return;const first=imgs[0];
        const apply=(img)=>{const isSq=img.naturalWidth&&img.naturalHeight&&Math.abs(img.naturalWidth-img.naturalHeight)<2;results.className=isSq?'grid':'list';};
        if(first.complete)apply(first);else first.onload=()=>apply(first);
      }

      const loadQueue=()=>{ try{return JSON.parse(localStorage.getItem('userQueue')||'[]');}catch{return[]} };
      const saveQueue=(arr)=>{ try{localStorage.setItem('userQueue',JSON.stringify(arr));}catch{} };

      function renderQueue(){
        const all=loadQueue();
        const last5=all.slice(0,5);
        histCount.textContent = all.length ? `(${Math.min(all.length,5)}/${all.length})` : '';
        userQueue.innerHTML='';
        const frag=document.createDocumentFragment();
        last5.forEach((t)=>{
          const li=document.createElement('li');
          li.className='q-item';
          li.innerHTML = `${t.img?`<img src="${t.img}" alt="">`:''}
            <div style="min-width:0">
              <div class="qi-title">${t.title||''}</div>
              <div class="qi-sub">${t.subtitle||''}</div>
            </div>`;
          frag.appendChild(li);
        });
        userQueue.appendChild(frag);
      }

      clearBtn.addEventListener('click', ()=>{
        stopPreview();
        closeEmbed();
        localStorage.removeItem('userQueue');
        localStorage.removeItem('addHistory');
        renderQueue();
        showPopup('History cleared');
      });

      function stopPreview(){
        try{ audio.pause(); audio.currentTime=0; }catch{}
        if(currentPreviewBtn){ currentPreviewBtn.textContent='Preview'; currentPreviewBtn.dataset.playing='false'; currentPreviewBtn=null; }
      }

      function openEmbedForUri(uri){
        const id = (uri||'').split(':')[2] || '';
        if(!id){ showPopup('Preview not available for this track.'); return; }
        stopPreview();
        embedFrame.src = `https://open.spotify.com/embed/track/${encodeURIComponent(id)}?utm_source=generator`;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
      }
      function closeEmbed(){
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');
        embedFrame.src = '';
      }
      embedClose.addEventListener('click', closeEmbed);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeEmbed(); });

      function togglePreview(btn, url, uri){
        if(url){
          if(btn===currentPreviewBtn && btn?.dataset.playing==='true'){
            stopPreview(); return;
          }
          stopPreview();
          audio.src=url;
          audio.play().then(()=>{
            btn.textContent='Stop';
            btn.dataset.playing='true';
            currentPreviewBtn=btn;
          }).catch(()=> showPopup('Cannot play preview. Check your browser audio permissions.'));
        } else {
          openEmbedForUri(uri);
        }
      }
      audio.addEventListener('ended', stopPreview);

      window.UIBridge={
        showLoading:()=>setState('loading'),
        showEmpty:()=>setState('empty'),
        showError:(msg)=>{error.textContent=msg||'Something went wrong.';setState('error');},
        showToast:(msg)=>showPopup(msg),
        renderItems:(items, query)=>{
          results.innerHTML='';
          setState('');

          if(!items || !items.length){
            const errorDiv = document.getElementById('state-error');
            errorDiv.textContent = `No results found for "${query || 'your search'}". Try another term.`;
            setState('error');
            return;
          }
          
          const frag=document.createDocumentFragment();
          items.slice(0,10).forEach((it)=>{
            const li=document.createElement('li');li.className='card';
            li.innerHTML=`
              <div class="cover">${it.image?`<img src="${it.image}" alt="">`:''}</div>
              <div class="info">
                <div class="title">${it.title||''}</div>
                <div class="meta">${it.subtitle||''}</div>
              </div>
              <div class="row">
                <button class="btn small ghost" data-act="preview">${it.preview ? 'Preview' : 'Preview'}</button>
                <button class="btn small" data-act="queue">Add to queue</button>
              </div>`;

            const previewBtn = li.querySelector('[data-act="preview"]');
            previewBtn.addEventListener('click', ()=> togglePreview(previewBtn, it.preview, it.uri));

            const queueBtn = li.querySelector('[data-act="queue"]');
            queueBtn.addEventListener('click', async ()=>{
              if(typeof window.canAddTrack==='function' && !window.canAddTrack()) return;

              queueBtn.disabled = true;
              let ok = false;
              if(typeof window.addToQueue === 'function' && it.uri){
                ok = await window.addToQueue(it.uri);
              } else if(typeof it.onclick === 'function'){
                try{ const res = it.onclick(); ok = res instanceof Promise ? await res : !!res; }catch{ ok=false; }
              }
              queueBtn.disabled = false;

              if(!ok) return;

              const data=loadQueue();
              data.unshift({title:it.title,subtitle:it.subtitle,img:it.image});
              saveQueue(data);
              renderQueue();

              if(typeof window.saveTrackAddition==='function') window.saveTrackAddition();

              const cover=li.querySelector('.cover');
              if(cover){
                cover.classList.add('bump');
                setTimeout(()=>cover.classList.remove('bump'),500);
                const badge=document.createElement('div');badge.className='added-badge';badge.textContent='Queued ✓';
                cover.appendChild(badge); setTimeout(()=>badge.remove(),1200);
              }
              li.classList.add('added'); setTimeout(()=>li.classList.remove('added'),800);
              showPopup('Added: '+(it.title||''));
              fireConfetti();

              results.innerHTML=''; q.value=''; setState('empty'); window.scrollTo({top:0,behavior:'smooth'});
            });

            frag.appendChild(li);
          });
          results.appendChild(frag);decideLayout();
        }
      };

      new MutationObserver(()=>decideLayout()).observe(results,{childList:true,subtree:true});

      results.addEventListener('click',(e)=>{
        const li=e.target.closest('.result-item'); if(!li) return;
        showPopup('Please use the new UI results.');
      });

      function triggerSearch(){
        stopPreview(); closeEmbed();
        const term=q.value.trim(); if(!term){showPopup('Please enter a valid search term.'); return;}
        setState('loading'); document.dispatchEvent(new CustomEvent('ui:search',{detail:{query:term,limit:10}}));
      }
      searchBtn.addEventListener('click',triggerSearch);
      window.addEventListener('keydown',(e)=>{if(e.key==='/'&&document.activeElement!==q){e.preventDefault();q.focus();}if(e.key==='Enter'&&document.activeElement===q){triggerSearch();}});

      renderQueue();
    })();
  </script>

  <script>
    (function showTutorialOnFirstVisit() {
      const tutorialModal = document.getElementById('tutorial-modal');
      const closeButton = document.getElementById('tutorial-close');
      if (localStorage.getItem('hasSeenTutorial') === 'true') {
        return;
      }
      tutorialModal.classList.add('show');
      tutorialModal.setAttribute('aria-hidden', 'false');
      closeButton.addEventListener('click', () => {
        tutorialModal.classList.remove('show');
        tutorialModal.setAttribute('aria-hidden', 'true');
        localStorage.setItem('hasSeenTutorial', 'true');
      });
    })();
  </script>

  <script>
    (async function loadEventConfig() {
      try {
        const response = await fetch('/api/config');
        if (!response.ok) return;
        
        const config = await response.json();
        const titleElement = document.getElementById('event-title');

        if (titleElement && config.eventName) {
          titleElement.textContent = `Benvenuto a ${config.eventName}!`;
        }
      } catch (error) {
        console.warn('Impossibile caricare la configurazione dell\'evento.', error);
      }
    })();
  </script>

  <script>
    (function nowPlayingPolling() {
      const widget = document.getElementById('now-playing-widget');
      const cover = document.getElementById('np-cover');
      const title = document.getElementById('np-title');
      const artists = document.getElementById('np-artists');
      let currentTrackUri = null;

      async function updateNowPlaying() {
        try {
          const response = await fetch('/api/player');
          if (!response.ok) return;

          const data = await response.json();

          if (data.isPlaying && data.uri) {
            // Ottimizzazione: aggiorna il DOM solo se la canzone è cambiata
            if (data.uri !== currentTrackUri) {
              cover.src = data.albumCover || '';
              title.textContent = data.track;
              artists.textContent = data.artists;
              currentTrackUri = data.uri;
            }
            widget.classList.add('visible');
          } else {
            widget.classList.remove('visible');
            currentTrackUri = null;
          }
        } catch (error) {
          console.warn('Errore durante l\'aggiornamento di "Now Playing".', error);
          widget.classList.remove('visible');
          currentTrackUri = null;
        }
      }

      // Esegui subito e poi ogni 15 secondi
      updateNowPlaying();
      setInterval(updateNowPlaying, 15000); 
    })();
  </script>
</body>
</html>
