<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#121212" />
  <title>Spotify Song Queue</title>
  <style>

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;line-height:1.5;-webkit-font-smoothing:antialiased;
      min-height:100svh;display:flex;flex-direction:column;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(29,185,84,.18), rgba(29,185,84,0) 60%),
        radial-gradient(800px 400px at 110% 0%, rgba(30,215,96,.12), rgba(30,215,96,0) 60%),
        linear-gradient(180deg,#0e0e0e 0%, #121212 35%, #0f1f15 100%);
      color:#fafafa;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial
    }
    img{display:block;max-width:100%}
    input,button{font:inherit}
    :root{--panel:#181818;--panel-2:#202020;--muted:#b3b3b3;--brand:#1DB954;--brand-2:#1ED760;--radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35)}

    .container{width:100%;max-width:1200px;margin:0 auto;padding:10px}
    header.appbar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(to bottom, rgba(18,18,18,.95), rgba(18,18,18,.7));border-bottom:1px solid rgba(255,255,255,.06)}
    .appbar-inner{display:flex;gap:10px;align-items:center;padding:8px 10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:8px}
    .brand img{width:32px;height:32px;cursor:pointer}

    .searchbar{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:999px;padding:6px 10px;flex:1;min-width:200px}
    .searchbar input{flex:1;outline:none;border:none;background:transparent;color:#fafafa}

    .btn{border:none;border-radius:12px;padding:8px 12px;background:linear-gradient(45deg,var(--brand),var(--brand-2));color:white;font-weight:700;cursor:pointer;transition:transform .15s ease;white-space:nowrap}
    .btn:hover{transform:translateY(-1px)}
    .btn.small{padding:6px 8px;border-radius:8px;font-size:12px;background:#262626;border:1px solid rgba(255,255,255,.08)}
    .btn.ghost{background:#1b1b1b;border:1px solid rgba(255,255,255,.08);color:#eaeaea}

    main{flex:1}
    .content{display:grid;grid-template-columns:1fr 300px;gap:12px}
    @media (max-width:900px){.content{grid-template-columns:1fr}}

    #results{list-style:none;padding:0;margin:10px 0}
    #results.grid{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(110px,1fr))}
    @media (max-width:1100px){#results.grid{grid-template-columns:repeat(4,minmax(110px,1fr))}}
    @media (max-width:960px){#results.grid{grid-template-columns:repeat(3,minmax(110px,1fr))}}
    @media (max-width:720px){#results.grid{grid-template-columns:repeat(2,minmax(120px,1fr))}}
    @media (max-width:400px){#results.grid{grid-template-columns:repeat(2,minmax(100px,1fr))}}
    #results.list{display:flex;flex-direction:column;gap:8px}

    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease;position:relative}
    .card:hover{transform:translateY(-2px)}
    .cover{position:relative;aspect-ratio:1/1;overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover}
    .info{padding:8px 10px}
    .title{font-size:14px;font-weight:800;white-space:normal;overflow-wrap:break-word}
    .meta{font-size:12px;color:var(--muted);white-space:normal;overflow-wrap:break-word}
    .row{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px 10px;flex-wrap:wrap}

    #results.list .card{flex-direction:row;align-items:center;padding:4px 6px}
    #results.list .cover{width:60px;height:60px;min-width:60px;border-radius:8px;margin:4px}
    #results.list .info{padding:0 8px;min-width:0}
    #results.list .row{margin-left:auto;padding:0}

    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:10px;position:sticky;top:72px;max-height:calc(100vh - 100px);overflow:auto}
    .panel .panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .panel h2{margin:0;font-size:15px}
    .q-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .q-item{display:flex;gap:8px;align-items:center;background:#161616;border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:6px}
    .q-item img{width:40px;height:40px;border-radius:6px;object-fit:cover}
    .qi-title{font-size:13px;font-weight:700;white-space:normal;overflow-wrap:break-word}
    .qi-sub{font-size:11px;color:var(--muted);white-space:normal;overflow-wrap:break-word}

    .state{display:none;align-items:center;justify-content:center;border:1px dashed rgba(255,255,255,.12);border-radius:var(--radius);padding:12px;text-align:center;color:var(--muted)}
    .state.active{display:flex}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(120%);background:#1b1b1b;color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:10px 14px;z-index:999;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;opacity:0;transition:transform .25s ease, opacity .25s ease}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{background:#2a1717;border-color:rgba(255,80,80,.35)}
    .toast .icon{font-weight:900}

    @keyframes ring{0%{box-shadow:0 0 0 0 rgba(29,185,84,.65)}100%{box-shadow:0 0 0 14px rgba(29,185,84,0)}}
    .card.added{animation:ring .75s ease-out}
    .added-badge{position:absolute;bottom:8px;right:8px;background:linear-gradient(45deg,var(--brand),var(--brand-2));color:#fff;padding:6px 8px;border-radius:999px;font-size:12px;font-weight:800;pointer-events:none;box-shadow:0 6px 18px rgba(0,0,0,.35)}

    .confetti{position:fixed;pointer-events:none;inset:0;z-index:998}

    footer{margin-top:auto;padding:12px;text-align:center;color:#b3b3b3;font-size:12px}
    footer a{color:var(--brand);text-decoration:none}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-inner container">
      <a class="brand" id="home-link" href="#" aria-label="Home">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/2048px-Spotify_logo_without_text.svg.png" alt="Spotify" />
      </a>
      <div class="searchbar" role="search">
        <input id="song-query" type="text" placeholder="Search songs, artists, albums…" autocomplete="off" aria-label="Search" />
      </div>
      <button id="search-btn" class="btn">Search</button>
    </div>
  </header>

  <main class="container">
    <div class="content">
      <section>
        <div id="state-empty" class="state active">Start by searching your favorite track.</div>
        <div id="state-loading" class="state">Searching… hold tight.</div>
        <div id="state-error" class="state">Something went wrong. Try again.</div>
        <ul id="results" class="grid" aria-label="Search results"></ul>
      </section>
      <aside class="panel">
        <div class="panel-head">
          <h2>History <span id="hist-count" style="color:var(--muted);font-weight:500"></span></h2>
          <button id="clear-history" class="btn small ghost" title="Clear history">Clear</button>
        </div>
        <ul id="user-queue" class="q-list" aria-live="polite" aria-label="Last 5 added"></ul>
      </aside>
    </div>
  </main>

  <footer>Developed by <a href="https://senioxtreme.it" target="_blank" rel="noreferrer noopener">Senioxtreme</a></footer>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"><span class="icon">✓</span><span id="toast-text"></span></div>
  <!-- Confetti canvas -->
  <canvas id="confetti" class="confetti"></canvas>

  <script>
    (function hardOverrideDialogs(){
      function htmlToast(msg){
        const t=document.getElementById('toast');
        const txt=document.getElementById('toast-text');
        if(!t||!txt) return;
        const m=(msg==null?'':String(msg));
        const isErr=/error|slow|limit|riprov|problem|no active device|valid search term/i.test(m);
        const icon=t.querySelector('.icon');
        if(icon) icon.textContent = isErr ? '⚠' : '✓';
        t.classList.toggle('error', isErr);
        txt.textContent=m;
        t.classList.add('show');
        clearTimeout(htmlToast._t);
        htmlToast._t=setTimeout(()=>t.classList.remove('show'),3500);
      }
      function setFn(name, fn, ret){
        try{ Object.defineProperty(window,name,{configurable:true,enumerable:true,writable:true,value:(...args)=>{ fn(args[0]); return ret; }}); }
        catch{ window[name]=(...args)=>{ fn(args[0]); return ret; }; }
      }
      setFn('alert', htmlToast, undefined);
      setFn('confirm', htmlToast, true);
      setFn('prompt', htmlToast, '');
      setInterval(()=>{ if(window.alert!==htmlToast) setFn('alert', htmlToast); }, 1000);
      window.showToast = htmlToast;
    })();
  </script>

  <script>
    const ext=document.createElement('script');
    ext.src='script.js?v='+Date.now();
    document.head.appendChild(ext);
  </script>

  <script>
    (function(){
      const q=document.getElementById('song-query');
      const searchBtn=document.getElementById('search-btn');
      const results=document.getElementById('results');
      const empty=document.getElementById('state-empty');
      const loading=document.getElementById('state-loading');
      const error=document.getElementById('state-error');
      const userQueue=document.getElementById('user-queue');
      const histCount=document.getElementById('hist-count');
      const clearBtn=document.getElementById('clear-history');
      const confetti=document.getElementById('confetti');
      const ctx=confetti.getContext('2d');

      document.getElementById('home-link').addEventListener('click',(e)=>{
        e.preventDefault();
        q.value=''; results.innerHTML=''; setState('empty'); window.scrollTo({top:0,behavior:'smooth'});
      });

      function setState(name){
        [empty,loading,error].forEach(el=>el.classList.remove('active'));
        if(name==='empty') empty.classList.add('active');
        if(name==='loading') loading.classList.add('active');
        if(name==='error') error.classList.add('active');
      }
      const showPopup=(msg)=> (window.showToast||(()=>{}))(msg==null?'':String(msg));

      function fireConfetti(){
        const W=confetti.width=window.innerWidth, H=confetti.height=window.innerHeight;
        const pieces=Array.from({length:18},()=>({x:Math.random()*W,y:-10,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,s:3+Math.random()*4}));
        let t=0; cancelAnimationFrame(fireConfetti._r);
        (function loop(){
          t++; ctx.clearRect(0,0,W,H);
          pieces.forEach(p=>{p.x+=p.vx; p.y+=p.vy; ctx.fillStyle=`hsl(${(t*6+p.x)%360} 80% 60%)`; ctx.fillRect(p.x,p.y,p.s,p.s*1.6);});
          if(t<40) fireConfetti._r=requestAnimationFrame(loop); else ctx.clearRect(0,0,W,H);
        })();
      }

      function decideLayout(){
        const imgs=[...results.querySelectorAll('.cover img, .result-item img')];
        if(!imgs.length)return;const first=imgs[0];
        const apply=(img)=>{const isSq=img.naturalWidth&&img.naturalHeight&&Math.abs(img.naturalWidth-img.naturalHeight)<2;results.className=isSq?'grid':'list';};
        if(first.complete)apply(first);else first.onload=()=>apply(first);
      }

      const loadQueue=()=>{ try{return JSON.parse(localStorage.getItem('userQueue')||'[]');}catch{return[]} };
      const saveQueue=(arr)=>{ try{localStorage.setItem('userQueue',JSON.stringify(arr));}catch{} };

      function renderQueue(){
        const all=loadQueue();
        const last5=all.slice(0,5); 
        histCount.textContent = all.length ? `(${Math.min(all.length,5)}/${all.length})` : '';
        userQueue.innerHTML='';
        const frag=document.createDocumentFragment();
        last5.forEach((t)=>{
          const li=document.createElement('li');
          li.className='q-item';
          li.innerHTML = `${t.img?`<img src="${t.img}" alt="">`:''}
            <div style="min-width:0">
              <div class="qi-title">${t.title||''}</div>
              <div class="qi-sub">${t.subtitle||''}</div>
            </div>`;
          frag.appendChild(li);
        });
        userQueue.appendChild(frag);
      }

      clearBtn.addEventListener('click', ()=>{
        localStorage.removeItem('userQueue');
        localStorage.removeItem('addHistory'); 
        renderQueue();
        showPopup('History cleared');
      });

      window.UIBridge={
        showLoading:()=>setState('loading'),
        showEmpty:()=>setState('empty'),
        showError:(msg)=>{error.textContent=msg||'Something went wrong.';setState('error');},
        showToast:(msg)=>showPopup(msg),
        renderItems:(items)=>{
          results.innerHTML='';setState('');
          if(!items||!items.length){setState('empty');return;}
          const frag=document.createDocumentFragment();
          items.slice(0,10).forEach((it)=>{
            const li=document.createElement('li');li.className='card';
            li.innerHTML=`
              <div class="cover">${it.image?`<img src="${it.image}" alt="">`:''}</div>
              <div class="info">
                <div class="title">${it.title||''}</div>
                <div class="meta">${it.subtitle||''}</div>
              </div>
              <div class="row">
                <button class="btn small" data-act="queue">Add to queue</button>
              </div>`;
            li.querySelector('[data-act="queue"]').addEventListener('click',()=>{

              if(typeof window.canAddTrack==='function' && !window.canAddTrack()) return;

              if(typeof it.onclick==='function') it.onclick();

              const data=loadQueue();
              data.unshift({title:it.title,subtitle:it.subtitle,img:it.image});
              saveQueue(data);
              renderQueue();

              if(typeof window.saveTrackAddition==='function') window.saveTrackAddition();

              const cover=li.querySelector('.cover');
              if(cover){
                const badge=document.createElement('div');badge.className='added-badge';badge.textContent='Queued ✓';
                cover.appendChild(badge); setTimeout(()=>badge.remove(),1200);
              }
              li.classList.add('added'); setTimeout(()=>li.classList.remove('added'),800);
              showPopup('Added: '+(it.title||''));
              fireConfetti();

              results.innerHTML=''; q.value=''; setState('empty'); window.scrollTo({top:0,behavior:'smooth'});
            });
            frag.appendChild(li);
          });
          results.appendChild(frag);decideLayout();
        }
      };

      new MutationObserver(()=>decideLayout()).observe(results,{childList:true,subtree:true});

      results.addEventListener('click',(e)=>{
        const li=e.target.closest('.result-item'); if(!li) return;
        if(typeof window.canAddTrack==='function' && !window.canAddTrack()) return;

        const title=li.querySelector('h2')?.textContent?.trim()||'';
        const sub=li.querySelector('p')?.textContent?.trim()||'';
        const img=li.querySelector('img')?.src||'';
        const data=loadQueue(); data.unshift({title,subtitle:sub,img}); saveQueue(data); renderQueue();

        try{li.style.position=li.style.position||'relative';}catch{}
        const b=document.createElement('div'); b.className='added-badge'; b.textContent='Queued ✓';
        li.appendChild(b); setTimeout(()=>b.remove(),1200);
        li.classList.add('added'); setTimeout(()=>li.classList.remove('added'),800);
        showPopup('Added: '+title); fireConfetti();

        results.innerHTML=''; q.value=''; setState('empty'); window.scrollTo({top:0,behavior:'smooth'});
      });

      function triggerSearch(){
        const term=q.value.trim(); if(!term){showPopup('Please enter a valid search term.'); return;}
        setState('loading'); document.dispatchEvent(new CustomEvent('ui:search',{detail:{query:term,limit:10}}));
      }
      searchBtn.addEventListener('click',triggerSearch);
      window.addEventListener('keydown',(e)=>{if(e.key==='/'&&document.activeElement!==q){e.preventDefault();q.focus();}if(e.key==='Enter'&&document.activeElement===q){triggerSearch();}});

      renderQueue();
    })();
  </script>
</body>
</html>
